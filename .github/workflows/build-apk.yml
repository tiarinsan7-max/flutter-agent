name: Build APK

on:
  push:
    branches:
      - main
      - develop
    tags:
      - 'v*.*.*'
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        required: true
        default: 'debug'
        type: choice
        options:
          - debug
          - release

env:
  FLUTTER_VERSION: '3.10.0'
  JAVA_VERSION: '17'

jobs:
  build:
    runs-on: ubuntu-latest
    name: Build APK

    permissions:
      contents: read
      pull-requests: read
      checks: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for versioning

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: gradle

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true
          cache-key: flutter-${{ env.FLUTTER_VERSION }}

      - name: Flutter info
        run: flutter --version && flutter doctor

      - name: Get dependencies
        run: flutter pub get

      - name: Generate build files
        run: flutter pub run build_runner build --delete-conflicting-outputs

      - name: Run tests
        run: flutter test --coverage
        continue-on-error: true

      - name: Upload coverage reports
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage/lcov.info
          flags: flutter
          fail_ci_if_error: false
        continue-on-error: true

      - name: Build debug APK
        if: github.event_name == 'pull_request' || (github.event_name == 'workflow_dispatch' && github.event.inputs.build_type == 'debug')
        run: flutter build apk --debug --split-per-abi

      - name: Setup signing for release APK
        if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/'))
        run: |
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > android/app/upload-keystore.jks
          echo "Keystore setup completed"
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}

      - name: Build release APK
        if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/'))
        run: flutter build apk --release --split-per-abi
        env:
          KEY_STORE_PASSWORD: ${{ secrets.KEY_STORE_PASSWORD }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
          ALIAS_USERNAME: ${{ secrets.ALIAS_USERNAME }}

      - name: Build release App Bundle
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
        run: flutter build appbundle --release
        env:
          KEY_STORE_PASSWORD: ${{ secrets.KEY_STORE_PASSWORD }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
          ALIAS_USERNAME: ${{ secrets.ALIAS_USERNAME }}

      - name: List build outputs
        if: always()
        run: |
          echo "=== Debug APK ===" 
          ls -lh build/app/outputs/flutter-apk/ 2>/dev/null || echo "No debug APK found"
          echo ""
          echo "=== Release APK ===" 
          ls -lh build/app/outputs/apk/release/ 2>/dev/null || echo "No release APK found"
          echo ""
          echo "=== App Bundle ===" 
          ls -lh build/app/outputs/bundle/release/ 2>/dev/null || echo "No app bundle found"

      - name: Upload APK artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: apk-builds
          path: |
            build/app/outputs/flutter-apk/**/*.apk
            build/app/outputs/apk/**/*.apk
          retention-days: 30

      - name: Upload App Bundle artifact
        uses: actions/upload-artifact@v4
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
        with:
          name: app-bundle
          path: build/app/outputs/bundle/release/app-release.aab
          retention-days: 30

      - name: Create Release
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            build/app/outputs/flutter-apk/app-*-release.apk
            build/app/outputs/apk/release/app-*-release.apk
            build/app/outputs/bundle/release/app-release.aab
          draft: false
          prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Build status
        if: always()
        run: |
          echo "Build Status: ${{ job.status }}"
          echo "Ref: ${{ github.ref }}"
          echo "Event: ${{ github.event_name }}"

  lint:
    runs-on: ubuntu-latest
    name: Lint & Analysis

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Run analyzer
        run: flutter analyze

      - name: Check formatting
        run: dart format --output=none --set-exit-if-changed .

      - name: Lint report
        if: always()
        run: |
          echo "âœ“ Lint check completed"

  security-scan:
    runs-on: ubuntu-latest
    name: Security Scan

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Run pub security audit
        run: flutter pub outdated --mode=null-safety
        continue-on-error: true

  notify:
    runs-on: ubuntu-latest
    name: Notify Build Status
    if: always()
    needs: [build, lint]

    steps:
      - name: Build summary
        run: |
          echo "Build Summary"
          echo "============="
          echo "Build Status: ${{ needs.build.result }}"
          echo "Lint Status: ${{ needs.lint.result }}"
